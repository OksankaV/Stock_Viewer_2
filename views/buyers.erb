<% content_for :head do %>
	<script type="text/javascript">
	$(document).ready(function() {
		$("#buyers_table").flexigrid({
			url: '/buyers_table',
			dataType: "json",
			colModel : [
				{display: "<%=Buyers_table_headers['buyer']%>", name : 'buyer', width : 300, sortable : true, align: 'left'},
				{display: "<%=Buyers_table_headers['notes']%>", name : 'notes', width : 900, sortable : true, align: 'left'},
				],
			buttons : [
				{name: 'Додати нового покупця', bimage: '/images/add-icon.png', onpress: add_new_buyer},
				{separator: true},
				{name: 'Видалити вибраних покупців', bimage: '/images/delete-icon.png', onpress: delete_selected_buyers},
				{separator: true},
				{name: 'Редагувати покупця', bimage: '/images/edit-icon.png', onpress: edit_buyer},
				{separator: true},
				{name: 'Переглянути список замовлень', bimage: '/images/orders-icon.png', onpress: orders_list},
				{separator: true}
				],
			searchitems : [
				{display: '<%=Buyers_table_headers['buyer']%>', name : 'buyer'},
				{display: '<%=Buyers_table_headers['notes']%>', name : 'notes', isdefault: true}
				],
			sortname: "iso",
			sortorder: "asc",
			usepager: true,
			useRp: true,
			rp: 15,
			showTableToggleBtn: true,
			width: 200,
			height: 660
		});
		
		function add_new_buyer(com, grid) 
		{	
			$('#add_buyer_link').click();
		}		

		function edit_buyer(com, grid) 
		{
			if ($('.trSelected', grid).length == '0')
			{
				alert('На вибрано жодного покупця.');
			}
			else if ($('.trSelected', grid).length == '1')
			{
				var items = $('.trSelected',grid);
				var edit_item = items[0].id;
				$.get("/edit_buyer_modal_form",
                	{item: edit_item},
                	function(data) {$('#edit_buyer_modal .modal-body').html(data)}
                );
                $('#edit_buyer_link').click();
			}
			else 
			{
				alert('Не можливо редагувати відразу декілька покупців, виберіть, будь ласка, лише одного покупця.');
			}			
		}
		
		function delete_selected_buyers(com, grid)
		{
			if ($('.trSelected', grid).length == '0')
			{
				alert('На вибрано жодного покупця');
			}
			else
			{
				var confirm_value = confirm('Ви впевнені, що хочете видалити вибраних покупців?');
				if (confirm_value)
				{
					var items = $('.trSelected',grid);
					var has_orders = false;
					var itemlist_without_orders = new Array();
					var item_index = 0;
					for(i=0;i<items.length;i++)
					{
                    	if (jQuery.inArray(items[i].id, <%=@buyers_from_orders_table.to_json%>) >= 0)
						{
							has_orders = true;
							var confirm_value_delete = confirm('Неможливо видалити всіх вибраних покупців, адже деякі з них мають замовлення. Хочете видалити тих, що не мають замовлень?');
							if (confirm_value_delete == false)
								return false;	
						}
						else
						{
                        	itemlist_without_orders[item_index] = items[i].id;
                        	item_index += 1;
						}
                    }
					$.get("/delete_buyers",
                       {items: itemlist_without_orders},
                       function(){ location.reload();}
                    );
				}
			}			
		}
		
		function orders_list(com, grid) 
		{	
			window.location.href='/orders'
		}	
		

		
		$("#add_new_buyer_button").click(function() {
			if ($('#input_buyer').val() == "")
			{
				alert ("Вкажіть покупця");
				return false;
			}
			if (jQuery.inArray($('#input_buyer').val(), <%=@buyers.to_json%>) >= 0)
			{
				alert ("Покупець '" + $('#input_buyer').val() + "' вже існує, неможливо додати.");
				return false;
			}

		});
			
	});
		

</script>
<style>
	.modal {
		width: 760px;
		margin-left: -380px;
	}
	.modal-body {
		max-height: 450px;
	}
	.row-fluid.middle{
    	 display: table-cell;
		  vertical-align: bottom;
		  float: none;
	}
</style>
<%end%>

<%if (@count > 0) %>
	<h5>Список покупців</h5>
	<table id="buyers_table" ></table>
<%else%>
	<div class="alert alert-info" align="center"><strong>Немає жодного покупця в базі даних</strong></div>
	<div align="center">
		<button class="btn btn-primary btn-large" type="button" onclick="$('#add_buyer_link').click();"><strong>Дотати нового покупця</strong></button>
	</div>	
<%end%>	

<a id="add_buyer_link" href="#add_buyer_modal" data-toggle="modal" hidden></a>
<a id="edit_buyer_link" href="#edit_buyer_modal" data-toggle="modal" hidden></a>
<a id="delete_buyer_link" href="#delete_buyer_modal" data-toggle="modal" hidden></a>

<div id="add_buyer_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="add_modal_label">Новий замовник</h3>
	</div>
	<div class="modal-body">
		<form id="add_new_buyer_form" action="/add_new_buyer" method="post">      
			<div class="row-fluid">   
				<div class="span24">
					<label for="input_buyer"><%=Orders_table_headers['buyer']%></label>
					<input type="text" id="input_buyer" name="input_buyer" class="span24">  
				</div>
			</div>
			<div class="row-fluid">
				<div class="span24">
					<label><%=Orders_table_headers['notes']%></label>
					<textarea type="text" id="input_notes" name="input_notes" class="span24" rows="2"></textarea>
				</div>
			</div>
			<input id="shown_modal" name="shown_modal" type="hidden" value="">
			<input id="edit_item" name="edit_item" type="hidden" value="">
		</form>
	</div>
	<div class="modal-footer">
		<button id="add_new_buyer_cencel" class="btn" data-dismiss="modal" aria-hidden="true">Відмінити</button>
		<button id="add_new_buyer_button" form="add_new_buyer_form" class="btn btn-primary">Зберегти</button>
	</div>
</div>

<div id="edit_buyer_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="edit_modal_label">Редагувати замовника</h3>
	</div>
	<div class="modal-body">
		
	</div>
	<div class="modal-footer">
		<button id="edit_buyer_cencel" class="btn" data-dismiss="modal" aria-hidden="true">Відмінити</button>
		<button id="edit_buyer_button" form="edit_buyer_form" class="btn btn-primary">Зберегти</button>
		
	</div>
</div>


